// ========== СИСТЕМА УРОВНЕЙ ==========

const levels = [
    {
        id: 0,
        name: "Beginner's Heart",
        description: "Start your journey with a simple heart",
        gridSize: 16,
        layers: ['dirt', 'grass'], // Только 2 слоя
        pixelArt: [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0],
            [0,0,1,2,2,2,1,0,1,2,2,2,1,0,0,0],
            [0,1,2,2,2,2,2,1,2,2,2,2,2,1,0,0],
            [0,1,2,2,2,2,2,2,2,2,2,2,2,1,0,0],
            [0,1,2,2,2,2,2,2,2,2,2,2,2,1,0,0],
            [0,0,1,2,2,2,2,2,2,2,2,2,1,0,0,0],
            [0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0],
            [0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
            [0,0,0,0,0,1,2,2,2,1,0,0,0,0,0,0],
            [0,0,0,0,0,0,1,2,1,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ],
        colors: {
            0: '#1a1a1a',  // фон
            1: '#8B4513',  // контур (коричневый)
            2: '#FF6B9D'   // сердце (розовый)
        },
        reward: {
            clickPowerBonus: 5,
            autoBonus: 2
        }
    },
    {
        id: 1,
        name: "Pixel Cat",
        description: "Create a cute pixel cat",
        gridSize: 16,
        layers: ['dirt', 'grass', 'wood'], // 3 слоя
        pixelArt: [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],
            [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
            [0,0,1,1,2,1,1,1,1,1,1,2,1,1,0,0],
            [0,0,1,1,2,1,1,1,1,1,1,2,1,1,0,0],
            [0,0,1,1,1,1,1,3,3,1,1,1,1,1,0,0],
            [0,0,1,1,1,1,3,3,3,3,1,1,1,1,0,0],
            [0,0,1,1,1,1,1,3,3,1,1,1,1,1,0,0],
            [0,0,1,1,4,1,1,1,1,1,1,4,1,1,0,0],
            [0,0,0,1,1,4,1,1,1,1,4,1,1,0,0,0],
            [0,0,0,1,1,1,4,4,4,4,1,1,1,0,0,0],
            [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
            [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ],
        colors: {
            0: '#1a1a1a',  // фон
            1: '#FF9E44',  // основной цвет котика (оранжевый)
            2: '#000000',  // глаза
            3: '#FFB6C1',  // нос
            4: '#FFC080'   // усы/рот
        },
        reward: {
            clickPowerBonus: 20,
            autoBonus: 10
        }
    },
    {
        id: 2,
        name: "Tiny Bird",
        description: "A small colorful bird",
        gridSize: 16,
        layers: ['dirt', 'grass', 'wood', 'stone'], // 4 слоя
        pixelArt: [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
            [0,0,0,0,1,2,2,2,1,0,0,0,0,0,0,0],
            [0,0,0,1,2,2,3,2,2,1,0,0,0,0,0,0],
            [0,0,1,2,2,2,2,2,2,1,4,0,0,0,0,0],
            [0,0,1,2,2,2,2,2,2,1,4,4,0,0,0,0],
            [0,0,1,2,2,2,2,2,2,2,1,0,0,0,0,0],
            [0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0],
            [0,0,0,0,1,5,5,5,1,0,0,0,0,0,0,0],
            [0,0,0,0,1,5,0,5,1,0,0,0,0,0,0,0],
            [0,0,0,0,1,5,0,5,1,0,0,0,0,0,0,0],
            [0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ],
        colors: {
            0: '#1a1a1a',  // фон
            1: '#000000',  // контур
            2: '#FFD700',  // тело (золотой)
            3: '#000000',  // глаз
            4: '#FF6347',  // клюв (красный)
            5: '#FFA500'   // лапки (оранжевый)
        },
        reward: {
            clickPowerBonus: 100,
            autoBonus: 50
        }
    },
    {
        id: 3,
        name: "Mushroom House",
        description: "A magical mushroom dwelling",
        gridSize: 16,
        layers: ['dirt', 'grass', 'wood', 'stone', 'metal'], // Все 5 слоёв
        pixelArt: [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
            [0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0],
            [0,0,0,1,2,2,3,2,2,3,2,2,1,0,0,0],
            [0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0],
            [0,1,2,2,3,2,2,2,2,2,2,3,2,2,1,0],
            [0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
            [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
            [0,0,0,0,0,1,4,4,4,4,1,0,0,0,0,0],
            [0,0,0,0,0,1,4,4,4,4,1,0,0,0,0,0],
            [0,0,0,0,0,1,4,5,5,4,1,0,0,0,0,0],
            [0,0,0,0,0,1,4,5,5,4,1,0,0,0,0,0],
            [0,0,0,0,0,1,4,5,5,4,1,0,0,0,0,0],
            [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ],
        colors: {
            0: '#1a1a1a',  // фон
            1: '#000000',  // контур
            2: '#FF4444',  // шляпка (красный)
            3: '#FFFFFF',  // точки на шляпке
            4: '#F5DEB3',  // стены дома (бежевый)
            5: '#8B4513'   // дверь/окна (коричневый)
        },
        reward: {
            clickPowerBonus: 500,
            autoBonus: 250
        }
    },
    {
        id: 4,
        name: "Diamond Gem",
        description: "A precious sparkling diamond",
        gridSize: 16,
        layers: ['dirt', 'grass', 'wood', 'stone', 'metal'], // Все 5 слоёв
        pixelArt: [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0],
            [0,0,0,0,0,1,2,3,3,2,1,0,0,0,0,0],
            [0,0,0,0,1,2,3,4,4,3,2,1,0,0,0,0],
            [0,0,0,1,2,3,4,5,5,4,3,2,1,0,0,0],
            [0,0,1,2,3,4,5,5,5,5,4,3,2,1,0,0],
            [0,0,1,2,3,4,5,5,5,5,4,3,2,1,0,0],
            [0,0,0,1,2,3,4,5,5,4,3,2,1,0,0,0],
            [0,0,0,0,1,2,3,4,4,3,2,1,0,0,0,0],
            [0,0,0,0,0,1,2,3,3,2,1,0,0,0,0,0],
            [0,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ],
        colors: {
            0: '#1a1a1a',  // фон
            1: '#000000',  // контур
            2: '#4169E1',  // темно-синий
            3: '#1E90FF',  // синий
            4: '#87CEEB',  // светло-синий
            5: '#E0FFFF'   // очень светлый (блик)
        },
        reward: {
            clickPowerBonus: 2500,
            autoBonus: 1250
        }
    }
];

// Получить текущий уровень
function getCurrentLevel() {
    return levels[gameState.currentLevel];
}

// Перейти на следующий уровень
function nextLevel() {
    if (gameState.currentLevel < levels.length - 1) {
        gameState.currentLevel++;
        return true;
    }
    return false;
}

// Сбросить уровень (для престижа)
function resetLevel() {
    const level = getCurrentLevel();
    
    // Применяем награды (они сохраняются!)
    gameState.materials.dirt.clickPower += level.reward.clickPowerBonus;
    gameState.materials.dirt.autoPerSec += level.reward.autoBonus;
    
    // Переходим на следующий уровень
    if (nextLevel()) {
        // СБРАСЫВАЕМ РЕСУРСЫ для нового уровня
        for (const mat in gameState.materials) {
            gameState.materials[mat].earned = 0;
            gameState.materials[mat].spendable = 0;
        }
        
        initLevel();
        initGrid();
        
        // Обновляем UI для разблокированных материалов
        const newLevel = getCurrentLevel();
        for (const [matName, mat] of Object.entries(gameState.materials)) {
            const resourceEl = document.getElementById(`${matName}-resource`);
            if (resourceEl) {
                if (mat.unlocked) {
                    resourceEl.classList.remove('locked');
                } else {
                    resourceEl.classList.add('locked');
                }
            }
        }
        
        updateUI();
        saveGame(); // Сохраняем прогресс
    } else {
        // Все уровни пройдены!
        showVictoryScreen();
    }
}

// Инициализация уровня
function initLevel() {
    const level = getCurrentLevel();
    
    // Сброс прогресса слоёв
    gameState.layerProgress = { dirt: 0, grass: 0, wood: 0, stone: 0, metal: 0 };
    gameState.currentLayer = level.layers[0];
    gameState.currentPixelClicks = 0;
    gameState.autoPixelClicks = 0;
    gameState.clicksPerPixel = gameState.baseClicksPerPixel[level.layers[0]];
    
    // Разблокируем только нужные слои для этого уровня
    for (const mat in gameState.materials) {
        gameState.materials[mat].unlocked = level.layers.includes(mat);
    }
    
    // Очищаем сетку
    gameState.grid = [];
    gameState.pixelOrder = [];
    gameState.allPixelsOrder = [];
}
